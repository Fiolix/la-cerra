
<section class="welcome">
  <h2>Welcome</h2>
  <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec sit amet sem euismod, tempor magna non, dignissim libero.</p>
  <p>Integer laoreet turpis non erat laoreet, in facilisis tellus finibus.</p>
</section>

<section class="news">
  <h2>News</h2>
  <div class="news-item">
    <h3>Erste Beispiel-News</h3>
    <img src="https://via.placeholder.com/600x200" alt="Platzhalterbild" style="width:100%; height:auto; border-radius: 0.3rem; margin: 0.5rem 0;" />
    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis ut purus eu libero dictum.</p>
    <a href="#">Read more</a>
  </div>
  <div class="news-item">
    <h3>Zweite Beispiel-News</h3>
    <img src="https://via.placeholder.com/600x200" alt="Platzhalterbild" style="width:100%; height:auto; border-radius: 0.3rem; margin: 0.5rem 0;" />
    <p>Morbi faucibus, odio in aliquam blandit, sapien urna rutrum velit, nec lacinia metus arcu eget.</p>
    <a href="#">Read more</a>
  </div>
</section>

<section class="login start-login" id="start-login-section">
  <h2>Login</h2>

  <div class="login-card" id="start-login-card">
    <label>
      Username<br>
      <input type="text" id="start-username" placeholder="yourname" autocomplete="username" />
    </label>
    <label>
      Password<br>
      <input type="password" id="start-password" placeholder="••••••••" autocomplete="current-password" />
    </label>

    <div class="start-actions">
      <button id="start-login-button" type="button" class="primary-btn">Log in</button>
    </div>

    <p id="start-login-error" class="error" aria-live="polite"></p>
  </div>

  <p class="register-teaser" id="start-register-teaser" style="text-align:center;">
    Don’t have an account yet? Join the La Cerra family and track your ascents in your personal tick list.
  </p>

  <div class="start-actions">
    <a id="start-register-button" class="primary-btn" href="register.html">Register</a>
  </div>

  <div id="already-logged-in" class="hidden" style="text-align:center;">
    <p>You are already logged in.</p>
    <a class="primary-btn" href="profile.html">Go to profile</a>
  </div>
</section>

<script type="module">
  import { supabase } from './supabase.js';

  async function handleStartLogin(){
    const username = document.getElementById('start-username').value.trim();
    const pw       = document.getElementById('start-password').value;
    const errEl    = document.getElementById('start-login-error');
    const btn      = document.getElementById('start-login-button');

    errEl.textContent = '';

    if (!username || !pw){
      errEl.textContent = 'Please enter username and password.';
      return;
    }

    // 1) Username -> Email aus profiles holen
    btn.disabled = true; btn.textContent = 'Checking…';
    const { data: prof, error: profErr } = await supabase
      .from('profiles')
      .select('email')
      .eq('username', username)
      .single();

    if (profErr || !prof?.email){
      btn.disabled = false; btn.textContent = 'Log in';
      errEl.textContent = 'User not found.';
      return;
    }

    // 2) Login per Email + Passwort
    btn.textContent = 'Signing in…';
    const { error: loginErr } = await supabase.auth.signInWithPassword({
      email: prof.email,
      password: pw
    });

    btn.disabled = false; btn.textContent = 'Log in';

    if (loginErr){
      errEl.textContent = 'Login failed: ' + (loginErr.message || 'Unknown error');
      return;
    }

    // Erfolg → Profil
    window.location.href = 'profile.html';
  }

  // Buttons/Enter binden
  document.getElementById('start-login-button')?.addEventListener('click', handleStartLogin);
  document.getElementById('start-password')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') handleStartLogin();
  });

  // Session prüfen → Login-Block ausblenden, Profil-Link zeigen
  supabase.auth.getSession().then(({ data }) => {
    if (data?.session?.user) {
      document.getElementById('start-login-card').classList.add('hidden');
      document.getElementById('start-register-teaser').classList.add('hidden');
      document.getElementById('start-register-button').classList.add('hidden');
      document.getElementById('already-logged-in').classList.remove('hidden');
    }
  });
</script>


